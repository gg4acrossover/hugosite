<!DOCTYPE html>
<html lang="vi-EN">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/agate.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-99127158-1', 'auto');
    ga('send', 'pageview');

    </script>

    
    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="Codable swift 4"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@viet142"/>



  	<meta property="og:title" content="Codable swift 4 &middot; GG4aCrossover" />
  	<meta property="og:site_name" content="GG4aCrossover" />
  	<meta property="og:url" content="https://gg4acrossover.github.io/hugosite/codable-swift4/" />

    
        
            <meta property="og:image" content="/hugosite/images/cover.jpg"/>
        
    

    
    <meta property="og:description" content="" />
  	<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2017-11-18T10:10:10&#43;07:00" />

    
    <meta property="article:tag" content="swift" />
    
    <meta property="article:tag" content="ios" />
    
    

    <title>Codable swift 4 &middot; GG4aCrossover</title>

    
    <meta name="description" content="Codable là gì? Chắc hẳn ở swift 3 đa số chúng ta sử dụng lib ObjectMapper để parse json thành model. Thư viện này khá tiện dụng, tuy nhiên có một nhược điểm là " />
    

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/hugosite/images/favicon.ico">
	  <link rel="apple-touch-icon" href="/hugosite/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="/hugosite/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="/hugosite/css/nav.css" />

    

    

    
      
          <link href="/hugosite/index.xml" rel="alternate" type="application/rss+xml" title="GG4aCrossover" />
      
      
    
    <meta name="generator" content="Hugo 0.20.7" />

    <link rel="canonical" href="https://gg4acrossover.github.io/hugosite/codable-swift4/" />

    
      
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": 
    },
    "author": {
        "@type": "Person",
        "name": ,
        
        "url": http://gg4acrossover.github.io/,
        "sameAs": [
            
            
             
             
             
             
             
            
        ],
        "description": Coder nhân dân
        
    },
    "headline": Codable swift 4,
    "name": Codable swift 4,
    "wordCount": 642,
    "timeRequired": "PT4M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": en
    },
    "url": https://gg4acrossover.github.io/hugosite/codable-swift4/,
    "datePublished": 2017-11-18T10:10Z,
    "dateModified": 2017-11-18T10:10Z,
    
    "keywords": swift, ios,
    "description": ,
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": https://gg4acrossover.github.io/hugosite/codable-swift4/
    }
}
    </script>
    


    

    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        

        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://twitter.com/viet142">Twitter</a>
            </li>
        
            <h4>Social</h4>
            <li class="nav-opened" role="presentation">
            	<a href="https://github.com/gg4acrossover">Github</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/hugosite/about/">About me</a>
            </li>
        
            <h4>My Site</h4>
            <li class="nav-opened" role="presentation">
            	<a href="/hugosite/">Home</a>
            </li>
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="/hugosite/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




<header class="main-header post-head no-cover">
  <nav class="main-nav clearfix">


  
  
      <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">Codable swift 4</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2017-11-18T10:10:10&#43;07:00">
            Nov 18, 2017
          </time>
        
         
          <span class="post-tag small"><a href="https://gg4acrossover.github.io/hugosite/tags/swift/">#swift</a></span>
         
          <span class="post-tag small"><a href="https://gg4acrossover.github.io/hugosite/tags/ios/">#ios</a></span>
         
        </section>
    </header>

    <section class="post-content">
      

<h2 id="codable-là-gì">Codable là gì?</h2>

<p>Chắc hẳn ở swift 3 đa số chúng ta sử dụng lib <em>ObjectMapper</em> để parse json thành model. Thư viện này khá tiện dụng, tuy nhiên có một nhược điểm là chúng ta vẫn phải viết hàm map key. Điều này mình không thích lắm, trước đây objc có <em>JSONModel</em> parse thông minh hơn hẳn, ai dùng qua chắc đều biết. Đáng tiếc là ở swift không có thằng nào như vầy cả.</p>

<p>Tuy nhiên điều đó đã thay đổi khi swift 4 xuất hiện đi kèm với <strong>Codable</strong>. Vậy <strong>Codable</strong> là gì?</p>

<p>Theo như Apple quảng cáo, <strong>Codable</strong> giúp ta được 2 việc:</p>

<ul>
<li>Encodable dùng để encoding</li>
<li>Decodable dùng để decoding</li>
</ul>

<blockquote>
<p>/// A type that can convert itself into and out of an external representation.</p>

<p>public typealias Codable = Decodable &amp; Encodable</p>
</blockquote>

<p>Về bản chất <strong>Codable</strong> là một protocol kết hợp giữa 2 protocol <em>Encodable</em> và <em>Decodable</em>, mỗi protocol lại đảm nhận chức năng như nói ở trên. Có thể coi <em>Codable</em> tương đương với một chiêu hai thức :D</p>

<h2 id="decodable-như-thế-nào">Decodable như thế nào?</h2>

<p>Giả sử ta có một json string như sau</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">json</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;&quot;&quot;</span>
<span style="color: #f8f8f2">[{</span>
    <span style="color: #e6db74">&quot;name&quot;</span><span style="color: #f92672">:</span><span style="color: #e6db74">&quot;cross&quot;</span><span style="color: #f8f8f2">,</span>
    <span style="color: #e6db74">&quot;age&quot;</span><span style="color: #f92672">:</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2">,</span>
    <span style="color: #e6db74">&quot;birthDay&quot;</span><span style="color: #f92672">:</span><span style="color: #e6db74">&quot;2017-06-21 20:20+0000&quot;</span>
<span style="color: #f8f8f2">}]</span>
<span style="color: #e6db74">&quot;&quot;&quot;</span>
</pre></div>


<p>Chúng ta sẽ định nghĩa struct kế thừa <em>Codable</em></p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">User</span> <span style="color: #f8f8f2">:</span> <span style="color: #f8f8f2">Codable</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">var</span> <span style="color: #f8f8f2">name:</span> <span style="color: #f8f8f2">String</span><span style="color: #f92672">?</span>
    <span style="color: #f8f8f2">var</span> <span style="color: #f8f8f2">age:</span> <span style="color: #f8f8f2">Int</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span>
    <span style="color: #f8f8f2">var</span> <span style="color: #f8f8f2">birthDay:</span> <span style="color: #f8f8f2">Date</span>
<span style="color: #f8f8f2">}</span>
</pre></div>


<p>Giờ là lúc thức thứ nhất <em>Decodable</em> thể hiện sức mạnh</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">// parse json with JSONDecoder</span>
<span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">decoder</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">JSONDecoder()</span>

<span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">dateFormater</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">DateFormatter()</span>
<span style="color: #f8f8f2">dateFormater.timeZone</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">TimeZone.current</span>
<span style="color: #f8f8f2">dateFormater.dateFormat</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;yyyy-MM-dd HH:mmZ&quot;</span>
<span style="color: #f8f8f2">decoder.dateDecodingStrategy</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">.formatted(dateFormater)</span>

<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">data</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">json.data(using:</span> <span style="color: #f8f8f2">.utf8)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">items</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">try</span><span style="color: #f92672">?</span> <span style="color: #f8f8f2">decoder.decode([User].self,</span> <span style="color: #f8f8f2">from:</span> <span style="color: #f8f8f2">data),</span>
        <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">date</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">items.first</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">.birthDay</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">print(dateFormater.string(from:</span> <span style="color: #f8f8f2">date))</span>
        <span style="color: #f8f8f2">print(items.first</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">.username</span> <span style="color: #f92672">??</span> <span style="color: #e6db74">&quot;something wrong&quot;</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&quot;error&quot;</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
</pre></div>


<p>Ở đây mình cố tình cho biến date vào trong json string, nên parse hơi dài (có thêm bước format data), tuy nhiên về cơ bản chỉ cần 2 dòng code tương ứng 2 bước:</p>

<ul>
<li>Convert json thành data</li>
<li>tạo đối tượng JSONDecoder để thực hiện decode</li>
</ul>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">// step 1</span>
<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">data</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">json.data(using:</span> <span style="color: #f8f8f2">.utf8)</span> <span style="color: #f8f8f2">{</span>
	<span style="color: #75715e">// step 2</span>
	<span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">items</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">try</span><span style="color: #f92672">?</span> <span style="color: #f8f8f2">JSONDecoder().decode([User].self,</span> <span style="color: #f8f8f2">from:</span> <span style="color: #f8f8f2">data)</span>
	<span style="color: #f8f8f2">...</span>
<span style="color: #f8f8f2">}</span>
</pre></div>


<p>Vì công thức chỉ có 2 bước, tương ứng với mọi đối tượng, thế nên mình có thể tạo Generic cho việc decoding như sau:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">typealias</span> <span style="color: #f8f8f2">DecoderConfig</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(JSONDecoder)</span> <span style="color: #f92672">-&gt;</span> <span style="color: #f8f8f2">()</span>
<span style="color: #f8f8f2">func</span> <span style="color: #f8f8f2">parseDecodableObject</span><span style="color: #f92672">&lt;</span><span style="color: #f8f8f2">T:</span> <span style="color: #f8f8f2">Decodable</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">(data:</span> <span style="color: #f8f8f2">Data,config:</span> <span style="color: #f8f8f2">DecoderConfig</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">throws</span> <span style="color: #f92672">-&gt;</span> <span style="color: #f8f8f2">T</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">decoder</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">JSONDecoder()</span>
    <span style="color: #f8f8f2">config</span><span style="color: #f92672">?</span><span style="color: #f8f8f2">(decoder)</span>
    <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">injectObject</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">try</span> <span style="color: #f8f8f2">decoder.decode(T.self,</span> <span style="color: #f8f8f2">from:</span> <span style="color: #f8f8f2">data)</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">injectObject</span>
<span style="color: #f8f8f2">}</span>
</pre></div>


<p>Tương ứng với code sẽ rút ngắn đi như thế này</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">item:</span> <span style="color: #f8f8f2">[User]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">try</span> <span style="color: #f8f8f2">parseDecodableObject(data:</span> <span style="color: #f8f8f2">data,</span> <span style="color: #f8f8f2">config:</span> <span style="color: #f8f8f2">config)</span>
</pre></div>


<p>Đôi khi, mình muốn đặt tên thuộc tính theo ý mình, không theo key trên server trả về, có được không nhỉ? <em>Decodable</em> bất chấp hết nhưng cần thêm 1 bước:</p>

<p>Giả sử ở <strong>struct User</strong> đầu ta đổi property name thành&hellip;username, ta sẽ phải thêm 1 enum <em>CodingKeys</em> kế thừa <em>CodingKey</em> vào trong struct User</p>

<p><img src="/hugosite/images/note/decodable.png" alt="image1" /></p>

<p>Có 2 điều bắt buộc đối với enum kế thừa <em>CodingKey</em>:</p>

<ul>
<li>Phải có type là <em>String</em>.</li>
<li>Các case phải trùng với tên thuộc tính của đối tượng. Với những thuộc tính cần mapping thì ta gán giá trị, vd: username gán giá trị là &ldquo;name&rdquo;(trùng với json key).</li>
</ul>

<h2 id="encoding-như-thế-nào">Encoding như thế nào?</h2>

<p>Thức thứ hai trong <em>Codable</em> là <em>Encodable</em>, về cơ bản nó ngược lại với <em>Decodable</em>, thế nên mình chỉ show code thôi.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">var</span> <span style="color: #f8f8f2">user:</span> <span style="color: #f8f8f2">User</span><span style="color: #f92672">?</span>
<span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">date</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">dateFormater.date(from:</span> <span style="color: #e6db74">&quot;2017-06-21 20:20+0000&quot;</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">user</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">User(username:</span> <span style="color: #e6db74">&quot;cross&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">age:</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">birthDay:</span> <span style="color: #f8f8f2">date)</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">encoder</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">JSONEncoder()</span>
<span style="color: #f8f8f2">encoder.dateEncodingStrategy</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">.formatted(dateFormater)</span>

<span style="color: #66d9ef">do</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">userData</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">try</span> <span style="color: #f8f8f2">encoder.encode(user)</span>
    <span style="color: #f8f8f2">let</span> <span style="color: #f8f8f2">userJson</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">try</span> <span style="color: #f8f8f2">JSONSerialization.jsonObject(with:</span> <span style="color: #f8f8f2">userData,</span> <span style="color: #f8f8f2">options:</span> <span style="color: #f8f8f2">[])</span>
    <span style="color: #f8f8f2">print(userJson)</span>
<span style="color: #f8f8f2">}</span> <span style="color: #f8f8f2">catch</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">print(error)</span>
<span style="color: #f8f8f2">}</span>
</pre></div>


<p>Về tính ứng dụng: với <em>Encodable</em> ta dễ dàng lưu struct vào <em>UserDefaults</em> hoặc tạo params để post lên server chẳng hạn.</p>

<p>Source code của toàn bộ ví dụ: <a href="https://gist.github.com/gg4acrossover/f27b8b0c2336c5bb7fc7f1a311a29537">source</a></p>

    </section>


  <footer class="post-footer">


    

    





<section class="author">
  <h4><a href="https://gg4acrossover.github.io/hugosite/">GG4aCrossover</a></h4>
  
  <p>Coder nhân dân</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">HaNoi, VietNam</span>
    <span class="author-link icon-link"><a href="http://gg4acrossover.github.io/">http://gg4acrossover.github.io/</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Codable%20swift%204&nbsp;-&nbsp;GG4aCrossover&amp;url=https%3a%2f%2fgg4acrossover.github.io%2fhugosite%2fcodable-swift4%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fgg4acrossover.github.io%2fhugosite%2fcodable-swift4%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fgg4acrossover.github.io%2fhugosite%2fcodable-swift4%2f&amp;description=Codable%20swift%204"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=https%3a%2f%2fgg4acrossover.github.io%2fhugosite%2fcodable-swift4%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'gg4acrossover';
  var disqus_url = 'https:\/\/gg4acrossover.github.io\/hugosite\/codable-swift4\/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




  </footer>
</article>

</main>


  <aside class="read-next">
  
      <a class="read-next-story" style="no-cover" href="/hugosite/method-dispatch/">
          <section class="post">
              <h2>Method dispath trong protocol</h2>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev" style="no-cover" href="/hugosite/date-la-gi/">
          <section class="post">
              <h2>Date là gì, có ăn được không?</h2>
          </section>
      </a>
  
</aside>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">GG4aCrossover</a> All rights reserved - 2016</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="/hugosite/js/jquery.js"></script>
    <script type="text/javascript" src="/hugosite/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/hugosite/js/index.js"></script>
    
</body>
</html>

